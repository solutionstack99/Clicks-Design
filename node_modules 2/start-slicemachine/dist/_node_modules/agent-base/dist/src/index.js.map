{"version":3,"file":"index.js","sources":["../../../../../../../node_modules/agent-base/dist/src/index.js"],"sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nconst events_1 = require(\"events\");\nconst debug_1 = __importDefault(require(\"debug\"));\nconst promisify_1 = __importDefault(require(\"./promisify\"));\nconst debug = debug_1.default('agent-base');\nfunction isAgent(v) {\n    return Boolean(v) && typeof v.addRequest === 'function';\n}\nfunction isSecureEndpoint() {\n    const { stack } = new Error();\n    if (typeof stack !== 'string')\n        return false;\n    return stack.split('\\n').some(l => l.indexOf('(https.js:') !== -1 || l.indexOf('node:https:') !== -1);\n}\nfunction createAgent(callback, opts) {\n    return new createAgent.Agent(callback, opts);\n}\n(function (createAgent) {\n    /**\n     * Base `http.Agent` implementation.\n     * No pooling/keep-alive is implemented by default.\n     *\n     * @param {Function} callback\n     * @api public\n     */\n    class Agent extends events_1.EventEmitter {\n        constructor(callback, _opts) {\n            super();\n            let opts = _opts;\n            if (typeof callback === 'function') {\n                this.callback = callback;\n            }\n            else if (callback) {\n                opts = callback;\n            }\n            // Timeout for the socket to be returned from the callback\n            this.timeout = null;\n            if (opts && typeof opts.timeout === 'number') {\n                this.timeout = opts.timeout;\n            }\n            // These aren't actually used by `agent-base`, but are required\n            // for the TypeScript definition files in `@types/node` :/\n            this.maxFreeSockets = 1;\n            this.maxSockets = 1;\n            this.maxTotalSockets = Infinity;\n            this.sockets = {};\n            this.freeSockets = {};\n            this.requests = {};\n            this.options = {};\n        }\n        get defaultPort() {\n            if (typeof this.explicitDefaultPort === 'number') {\n                return this.explicitDefaultPort;\n            }\n            return isSecureEndpoint() ? 443 : 80;\n        }\n        set defaultPort(v) {\n            this.explicitDefaultPort = v;\n        }\n        get protocol() {\n            if (typeof this.explicitProtocol === 'string') {\n                return this.explicitProtocol;\n            }\n            return isSecureEndpoint() ? 'https:' : 'http:';\n        }\n        set protocol(v) {\n            this.explicitProtocol = v;\n        }\n        callback(req, opts, fn) {\n            throw new Error('\"agent-base\" has no default implementation, you must subclass and override `callback()`');\n        }\n        /**\n         * Called by node-core's \"_http_client.js\" module when creating\n         * a new HTTP request with this Agent instance.\n         *\n         * @api public\n         */\n        addRequest(req, _opts) {\n            const opts = Object.assign({}, _opts);\n            if (typeof opts.secureEndpoint !== 'boolean') {\n                opts.secureEndpoint = isSecureEndpoint();\n            }\n            if (opts.host == null) {\n                opts.host = 'localhost';\n            }\n            if (opts.port == null) {\n                opts.port = opts.secureEndpoint ? 443 : 80;\n            }\n            if (opts.protocol == null) {\n                opts.protocol = opts.secureEndpoint ? 'https:' : 'http:';\n            }\n            if (opts.host && opts.path) {\n                // If both a `host` and `path` are specified then it's most\n                // likely the result of a `url.parse()` call... we need to\n                // remove the `path` portion so that `net.connect()` doesn't\n                // attempt to open that as a unix socket file.\n                delete opts.path;\n            }\n            delete opts.agent;\n            delete opts.hostname;\n            delete opts._defaultAgent;\n            delete opts.defaultPort;\n            delete opts.createConnection;\n            // Hint to use \"Connection: close\"\n            // XXX: non-documented `http` module API :(\n            req._last = true;\n            req.shouldKeepAlive = false;\n            let timedOut = false;\n            let timeoutId = null;\n            const timeoutMs = opts.timeout || this.timeout;\n            const onerror = (err) => {\n                if (req._hadError)\n                    return;\n                req.emit('error', err);\n                // For Safety. Some additional errors might fire later on\n                // and we need to make sure we don't double-fire the error event.\n                req._hadError = true;\n            };\n            const ontimeout = () => {\n                timeoutId = null;\n                timedOut = true;\n                const err = new Error(`A \"socket\" was not created for HTTP request before ${timeoutMs}ms`);\n                err.code = 'ETIMEOUT';\n                onerror(err);\n            };\n            const callbackError = (err) => {\n                if (timedOut)\n                    return;\n                if (timeoutId !== null) {\n                    clearTimeout(timeoutId);\n                    timeoutId = null;\n                }\n                onerror(err);\n            };\n            const onsocket = (socket) => {\n                if (timedOut)\n                    return;\n                if (timeoutId != null) {\n                    clearTimeout(timeoutId);\n                    timeoutId = null;\n                }\n                if (isAgent(socket)) {\n                    // `socket` is actually an `http.Agent` instance, so\n                    // relinquish responsibility for this `req` to the Agent\n                    // from here on\n                    debug('Callback returned another Agent instance %o', socket.constructor.name);\n                    socket.addRequest(req, opts);\n                    return;\n                }\n                if (socket) {\n                    socket.once('free', () => {\n                        this.freeSocket(socket, opts);\n                    });\n                    req.onSocket(socket);\n                    return;\n                }\n                const err = new Error(`no Duplex stream was returned to agent-base for \\`${req.method} ${req.path}\\``);\n                onerror(err);\n            };\n            if (typeof this.callback !== 'function') {\n                onerror(new Error('`callback` is not defined'));\n                return;\n            }\n            if (!this.promisifiedCallback) {\n                if (this.callback.length >= 3) {\n                    debug('Converting legacy callback function to promise');\n                    this.promisifiedCallback = promisify_1.default(this.callback);\n                }\n                else {\n                    this.promisifiedCallback = this.callback;\n                }\n            }\n            if (typeof timeoutMs === 'number' && timeoutMs > 0) {\n                timeoutId = setTimeout(ontimeout, timeoutMs);\n            }\n            if ('port' in opts && typeof opts.port !== 'number') {\n                opts.port = Number(opts.port);\n            }\n            try {\n                debug('Resolving socket for %o request: %o', opts.protocol, `${req.method} ${req.path}`);\n                Promise.resolve(this.promisifiedCallback(req, opts)).then(onsocket, callbackError);\n            }\n            catch (err) {\n                Promise.reject(err).catch(callbackError);\n            }\n        }\n        freeSocket(socket, opts) {\n            debug('Freeing socket %o %o', socket.constructor.name, opts);\n            socket.destroy();\n        }\n        destroy() {\n            debug('Destroying agent %o', this.constructor.name);\n        }\n    }\n    createAgent.Agent = Agent;\n    // So that `instanceof` works correctly\n    createAgent.prototype = createAgent.Agent.prototype;\n})(createAgent || (createAgent = {}));\nmodule.exports = createAgent;\n//# sourceMappingURL=index.js.map"],"names":["this","require$$1","require$$2","createAgent"],"mappings":"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","x_google_ignoreList":[0]}